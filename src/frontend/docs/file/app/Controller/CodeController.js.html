<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">app/Controller/CodeController.js | Frank!Flow</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="dev tool to work with the Frank framework"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Frank!Flow"><meta property="twitter:description" content="dev tool to work with the Frank framework"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#controller">Controller</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Controller/CodeController.js~CodeController.html">CodeController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Controller/FlowController.js~FlowController.html">FlowController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Controller/PipeInfoController.js~PipeInfoController.html">PipeInfoController</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#converter">Converter</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Converter/ConfigurationConverter.js~ConfigurationConverter.html">ConfigurationConverter</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#facade">Facade</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Facade/CodeFacade.js~CodeFacade.html">CodeFacade</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#model">Model</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Model/FileModel.js~FileModel.html">FileModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Model/FlowModel.js~FlowModel.html">FlowModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Model/IbisdocModel.js~IbisdocModel.html">IbisdocModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Model/PipeModel.js~PipeModel.html">PipeModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/Model/XsdModel.js~XsdModel.html">XsdModel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-codeview">View/codeView</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/CodeView.js~CodeView.html">CodeView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/FileTreeView.js~FileTreeView.html">FileTreeView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/ToBeautifulSyntax.js~ToBeautifulSyntax.html">ToBeautifulSyntax</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/ValidateConfigurationView.js~ValidateConfigurationView.html">ValidateConfigurationView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-logColor">logColor</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-codeview-codecompletion">View/codeView/codeCompletion</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/codeCompletion/XSDCodeCompletionView.js~XSDCodeCompletionView.html">XSDCodeCompletionView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-codeview-codeeditviews">View/codeView/codeEditViews</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/codeEditViews/CodeAttributesView.js~CodeAttributesView.html">CodeAttributesView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/codeEditViews/CodeEditView.js~CodeEditView.html">CodeEditView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/codeEditViews/CodeParametersView.js~CodeParametersView.html">CodeParametersView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/codeEditViews/CodePipeView.js~CodePipeView.html">CodePipeView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/codeEditViews/CodeTypesView.js~CodeTypesView.html">CodeTypesView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/codeEditViews/ExitPipeView.js~ExitPipeView.html">ExitPipeView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/codeView/codeEditViews/OptionView.js~OptionView.html">OptionView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-flowview">View/flowView</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/DescriptionView.js~DescriptionView.html">DescriptionView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/FlowView.js~FlowView.html">FlowView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/TypeImageView.js~TypeImageView.html">TypeImageView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-flowview-flowgeneration">View/flowView/flowGeneration</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/flowGeneration/CustomElementGenerator.js~CustomElementGenerator.html">CustomElementGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/flowGeneration/FlowGenerator.js~FlowGenerator.html">FlowGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/flowGeneration/ForwardGenerator.js~ForwardGenerator.html">ForwardGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/flowGeneration/PipeGenerator.js~PipeGenerator.html">PipeGenerator</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-flowview-pipe">View/flowView/pipe</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/pipe/ActivityPipeView.js~ActivityPipeView.html">ActivityPipeView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/pipe/PipeBuilder.js~PipeBuilder.html">PipeBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/flowView/pipe/PipeView.js~PipeView.html">PipeView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-paletteview">View/paletteView</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/paletteView/PaletteView.js~PaletteView.html">PaletteView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-pipeinfoview">View/pipeInfoView</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/pipeInfoView/PipeInfoView.js~PipeInfoView.html">PipeInfoView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-pipeinfoview-specialpipes">View/pipeInfoView/SpecialPipes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/pipeInfoView/SpecialPipes/XsltInfoView.js~XsltInfoView.html">XsltInfoView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-pipeinfoview-attributes">View/pipeInfoView/attributes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/pipeInfoView/attributes/GenerateInfoAttributesView.js~GenerateInfoAttributesView.html">GenerateInfoAttributesView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view-pipeinfoview-parameters">View/pipeInfoView/parameters</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/View/pipeInfoView/parameters/GenerateInfoParametersView.js~GenerateInfoParametersView.html">GenerateInfoParametersView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services">services</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/FileService.js~FileService.html">FileService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/IbisdocService.js~IbisdocService.html">IbisdocService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/PipeService.js~PipeService.html">PipeService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/XsdService.js~XsdService.html">XsdService</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">app/Controller/CodeController.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import CodeView from &apos;../View/codeView/CodeView.js&apos;;
import FileTreeView from &apos;../View/codeView/FileTreeView.js&apos;;
import FileService from &apos;../services/FileService.js&apos;;
import XsdModel from &apos;../Model/XsdModel&apos;;
import * as beautify from &apos;vkbeautify&apos;;
import XsdService from &apos;../services/XsdService.js&apos;;
import IbisdocService from &apos;../services/IbisdocService.js&apos;;
import FileModel from &apos;../Model/FileModel.js&apos;;

export default class CodeController {

  constructor(mainController, ibisdocModel) {
    this.mainController = mainController;

    this.xsdModel = new XsdModel();
    this.ibisdocModel = ibisdocModel;
    this.fileModel = new FileModel();

    this.codeView = new CodeView(this.xsdModel);
    this.fileModel.addListener(this)
    this.codeView.addListener(this);

    this.fileService = new FileService(this);
    this.xsdService = new XsdService(this.xsdModel);
    this.ibisdocService = new IbisdocService(this.ibisdocModel, this.codeView);

    this.fileService.getConfigurations();
    this.xsdService.getXsd();
    this.ibisdocService.getIbisdoc();

    this.codeView.makeEditor();
    this.editor = this.codeView.editor;

    this.fileTreeView = new FileTreeView(this.editor, this.fileService);
    this.initListeners();
  }


  //_______________Event handlers_______________

  initListeners() {
    let cur = this;

    $.contextMenu({
      selector: &apos;.folder&apos;,
      zIndex: 3001,
      callback: function (key, options) {
        var m = &quot;clicked: &quot; + key;
        window.console &amp;&amp; console.log(m) || alert(m);
        return true;
      },
      items: {
        &quot;addFile&quot;: {
          name: &quot;Add file&quot;, icon: &quot;fas fa-file&quot;,
          callback: function () {
            let path = $(this).attr(&apos;data-name&apos;);
            console.log(&apos;add path: &apos;, path)
            cur.fileTreeView.addFile(path);
            return true;
          }
        }
      }
    });

    $.contextMenu({
      selector: &apos;.file&apos;,
      zIndex: 3001,
      callback: function (key, options) {
        var m = &quot;clicked: &quot; + key;
        window.console &amp;&amp; console.log(m) || alert(m);
        return true;
      },
      items: {
        &quot;rename&quot;: {
          name: &quot;Rename file&quot;, icon: &quot;fas fa-file&quot;,
          callback: function () {
            console.log($(this).attr(&apos;data-name&apos;));
            let path = $(this).attr(&apos;data-name&apos;);
            let newPath = prompt(&quot;new name&quot;);
            cur.fileTreeView.renameFile(path, newPath);
            return true;
          }
        },
        &quot;delete&quot;: {
          name: &quot;Delete file&quot;, icon: &quot;fas fa-trash&quot;,
          callback: function () {
            let path = $(this).attr(&apos;data-name&apos;);
            cur.fileTreeView.deleteFile(path);
            return true;
          }
        }
      }
    });

    $(&apos;#adapterSelect&apos;).on(&apos;change&apos;, function (e) {
      let adapterName = $(&apos;#adapterSelect&apos;).val();
      localStorage.setItem(&apos;currentAdapter&apos;, adapterName)
      cur.quickGenerate();

    });

    $(&apos;#fileReader&apos;).on(&apos;change&apos;, function (e) {
      var input = event.target;
      console.log(input, input.webkitEntries);
      cur.fileTreeView.makeTree(input, cur.editor);
      $(&apos;#adapterSelect&apos;).css(&apos;display&apos;, &apos;none&apos;);
    });


    $(&apos;#saveFile&apos;).on(&apos;click&apos;, function (e) {
      cur.saveFile();
    })

    $(&apos;#beautify&apos;).click(function () {
      let prettyXML = beautify.xml(cur.editor.getValue(), 4);
      cur.editor.getModel().setValue(prettyXML);
    });

    $(&apos;#addFile&apos;).click(function () {
      console.log(&apos;add a file!&apos;);
      cur.fileTreeView.addFile(&quot;FrankConfiguration/&quot;);
    })


    cur.editor.onMouseDown(function (e) {
      e.target.range.startLineNumber = 1;
      e.target.range.startColumn = 1;
      let textPossition = cur.editor.getModel().getValueInRange(e.target.range);
      let adapters = textPossition.match(/&lt;Adapter[^]*?name=&quot;.*?&quot;&gt;/g);
      if (adapters != null) {
        let adapterName = adapters[adapters.length - 1].match(/name=&quot;[^]*?&quot;/g)[0].match(/&quot;[^]*?&quot;/g)[0].replace(/&quot;/g, &apos;&apos;);
        if (localStorage.getItem(&quot;currentAdapter&quot;) != adapterName) {
          localStorage.setItem(&quot;currentAdapter&quot;, adapterName);
          cur.quickGenerate();
        }
      }
    })


    this.editor.getModel().onDidChangeContent(cur.debounce(function () {
      cur.quickGenerate()
    }, 250))

    $(&apos;#runXsd&apos;).click(function () {
      let validate = cur.validateConfiguration(),
        lineNumber = 0;
      cur.undoDecorations();
      if (validate.errors !== null) {
        console.log(validate.errors);
        validate.errors.forEach(function (item, index) {
          lineNumber = item.match(/:.*?:/)[0].replace(/:/g, &apos;&apos;);
          cur.decorateLine(lineNumber);
        });
      }
    })
  }

  //_______________Custom methods to be called from handlers_______________

  quickGenerate() {
    let cur = this;
    if (!cur.mainController.flowController.flowView.moving &amp;&amp; !cur.mainController.flowController.flowView.adding) {
      try {
        $(&apos;#canvas&apos;).css(&apos;display&apos;, &apos;block&apos;);
        $(&apos;.customErrorMessage&apos;).remove();
        cur.mainController.generateFlow();
      } catch (error) {
        console.log(&quot;error&quot;, error);
        cur.mainController.flowController.flowView.modifyFlow(&quot;error&quot;, error);
      }
    }
  }

  debounce(func, wait, immediate) {
    var timeout;
    return function () {
      var context = this,
        args = arguments;
      var later = function () {
        timeout = null;
        if (!immediate) func.apply(context, args);
      };
      var callNow = immediate &amp;&amp; !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) func.apply(context, args);
    };
  };

  saveFile() {
    let zip = this.fileTreeView.zip;
    var FileSaver = require(&apos;file-saver&apos;);
    zip.generateAsync({
      type: &quot;blob&quot;
    }).then(function (myzip) {
      //FileSaver.saveAs(blob, &quot;FrankConfiguration&quot;);
      console.log(myzip);
      var fileName = &apos;configuration.zip&apos;;

      var fd = new FormData();
      const finalurl = &apos;http://localhost/iaf/api/configurations&apos;;
      fd.append(&quot;datasource&quot;, &apos;jdbc/frank2manual&apos;);
      fd.append(&quot;name&quot;, &quot;PROJECTNAME&quot;);
      fd.append(&quot;version&quot;, &apos;5&apos;);
      fd.append(&quot;encoding&quot;, &apos;utf-8&apos;);
      fd.append(&quot;multiple_configs&quot;, false);
      fd.append(&quot;activate_config&quot;, true);
      fd.append(&quot;automatic_reload&quot;, true);
      fd.append(&quot;file&quot;, myzip, fileName);

      fetch(finalurl, {
        method: &apos;post&apos;,
        body: fd,
      }).then(res =&gt; {
        console.log(res)
        return res.text();
      }).then(re =&gt; {
        console.log(re)
      })      
      .catch(e =&gt; {
        console.log(e)
      })

    })
  }

  //_______________Methods for modifying the editor_______________

  setEditorValue(value) {
    this.codeView.setEditorValue(value);
  }

  selectPipe(name) {
    this.codeView.selectPipe(name);
  }
  getTypes() {
    return this.codeView.getTypes();
  }
  validateConfiguration() {
    return this.codeView.validateConfigurationView.validateConfiguration();
  }
  decorateLine(lineNumber) {
    this.codeView.validateConfigurationView.decorateLine(lineNumber);
  }
  undoDecorations() {
    this.codeView.validateConfigurationView.undoDecorations();
  }
  changeName(oldWord, newWord) {
    this.codeView.changeName(oldWord, newWord);
  }
  changePipeType(name, type, oldType) {
    this.codeView.changePipeType(name, type, oldType);
  }
  changePossition(name, newX, newY) {
    this.codeView.changePossition(name, newX, newY);
  }
  changeExitPossition(name, newX, newY) {
    this.codeView.changeExitPossition(name, newX, newY);
  }
  changeAddForward(name, path) {
    this.codeView.changeAddForward(name, path);
  }
  deleteForward(name, path) {
    this.codeView.deleteForward(name, path);
  }
  changeAddPipe(name, possitions, className) {
    this.codeView.changeAddPipe(name, possitions, className);
  }
  getPipes() {
    return this.codeView.ibisdocJson;
  }
  getAttributes(name) {
    return this.codeView.getAttributes(name);
  }
  getParameters(name) {
    return this.codeView.getParameters(name);
  }
  changeAttribute(pipeName, attribute, attributeValue) {
    this.codeView.changeAttribute(pipeName, attribute, attributeValue);
  }
  addAttribute(pipeName, attribute) {
    this.codeView.addAttribute(pipeName, attribute);
  }
  deleteAttribute(pipeName, attribute) {
    this.codeView.deleteAttribute(pipeName, attribute);
  }
  addParameter(pipeName, paramName) {
    this.codeView.addParameter(pipeName, paramName);
  }
  deleteParameter(pipeName, paramName) {
    this.codeView.deleteParameter(pipeName, paramName);
  }
  addParameterAttribute(pipeName, paramName, attribute) {
    this.codeView.addParameterAttribute(pipeName, paramName, attribute);
  }
  changeParameterAttribute(pipeName, paramName, attribute, value) {
    this.codeView.changeParameterAttribute(pipeName, paramName, attribute, value);
  }

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
